# Shell path
export SHELL=/bin/zsh

# Tool version manager
if command -v ~/.local/bin/mise >/dev/null 2>&1; then
  eval "$(~/.local/bin/mise activate zsh)"
fi

# Use zsh's path array
typeset -U path
path=(
  /opt/homebrew/bin
  $HOME/bin
  /usr/local/bin
  $HOME/go/bin
  $HOME/.cargo/bin
  $HOME/.bun/bin
  $HOME/.local/share/nvim/mason/bin
  $HOME/.opencode/bin
  $HOME/.local/bin
  $path
)

# Homebrew-provided client CLIs (if installed)
if command -v brew >/dev/null 2>&1; then
  if [ -d "$(brew --prefix)/opt/libpq/bin" ]; then
    path=("$(brew --prefix)/opt/libpq/bin" $path)
  fi
  if [ -d "$(brew --prefix)/opt/mysql-client/bin" ]; then
    path=("$(brew --prefix)/opt/mysql-client/bin" $path)
  fi
fi

# Basic completion setup
autoload -U +X compinit

# Cache completion if nothing changed - faster startup time
# Rebuild daily to pick up new completions
typeset -i updated_at=$(date +'%j' -r ~/.zcompdump 2>/dev/null || stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null)
if [ $(date +'%j') != $updated_at ]; then
  compinit -i
else
  compinit -C -i
fi

# Essential completion and history files
source "$HOME/.zsh/completion.zsh"
source "$HOME/.zsh/history.zsh"

# Enhanced menu completion module
zmodload -i zsh/complist

# Additional completion search paths
typeset -U fpath
fpath=(
  $HOME/.zsh_functions
  $(brew --prefix 2>/dev/null)/share/zsh/site-functions
  $(brew --prefix 2>/dev/null)/share/zsh-completions
  $fpath
)

if [ -z "$CURSOR_AGENT" ]; then
  # --- Editors ---
  export EDITOR=cursor
  export VISUAL=$EDITOR
  export GIT_EDITOR=vim

  # --- FZF defaults ---
  export FZF_DEFAULT_COMMAND='fd --type file'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

  # --- Language/tooling env ---
  # Elixir/Erlang
  export KERL_BUILD_DOCS="yes"
  export ERL_AFLAGS="-kernel shell_history enabled"

  # Go
  export GOPATH=$HOME/go
  export GOPROXY=direct

  # --- Tool initializations ---
  if command -v fzf >/dev/null 2>&1; then
    eval "$(fzf --zsh)"
  fi

  if command -v chezmoi >/dev/null 2>&1; then
    eval "$(chezmoi completion zsh)"
  fi

  if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
  fi

  # --- Aliases ---
  alias ls="eza --icons=always"
  alias lg=lazygit
  alias chez=chezmoi
  alias c=cursor
  alias ca=cursor-agent
  alias cau='cursor-agent update'

  # --- Tool integrations ---
  if command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init zsh)"
  fi

  # Enhanced plugins and completions
  source "$HOME/.zsh/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"
  source "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.plugin.zsh"
  source "$HOME/.zsh/key-bindings.zsh"
fi

# --- Local overrides ---
[ -f "$HOME/.zshrc.local" ] && . "$HOME/.zshrc.local"
