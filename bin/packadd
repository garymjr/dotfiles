#!/usr/bin/env node

const { spawnSync } = require("child_process");

function findBranch(args) {
  const re = /--branch=\w+/;
  const [branchMatch] = args.filter(a => a.match(re));
  if (branchMatch) {
    return branchMatch.split("=").slice(-1)[0];
  }
  return "master";
}

function getDir(repo) {
  const [dir] = repo.split("/").slice(-2, -1);
  return dir;
}

function getPack(repo) {
  const [pack] = repo.split("/").slice(-1);
  return pack.replace(".git", "");
}

function main() {
  const [repo, ...args] = process.argv.slice(2);
  const branch = findBranch(args);
  const dir = getDir(repo);
  const pack = getPack(repo);

  const { stdout, stderr } = spawnSync(
    "git",
    [
      "subtree",
      "add",
      "--prefix",
      `vim/.vim/pack/${dir}/opt/${pack}`,
      repo,
      branch,
      "--squash"
    ],
    { cwd: `${process.env.HOME}/dotfiles` }
  );

  if (stdout) {
    console.log(stdout.toString());
  } else {
    console.log(stderr.toString());
  }
}

main();
